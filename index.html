<html>
	<head>
		<title>nski</title>
		<link rel="stylesheet"
			  href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
			  crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
				integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
				crossorigin=""></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"
				integrity="sha512-MMmVaQGDVI3Wouc5zT5G7k/snN9gPqquIhZsHgIIHVDlRgYTYGxrwu6w482iIhAq8n5R6+pcBgpGgxFFBz7rZA=="
				crossorigin="anonymous"
				referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
				integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
				crossorigin="anonymous"
				referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"
				integrity="sha512-8BqQ2RH4L4sQhV41ZB24fUc1nGcjmrTA6DILV/aTPYuUzo+wBdYdp0fvQ76Sxgf36p787CXF7TktWlcxu/zyOg=="
				crossorigin="anonymous"
				referrerpolicy="no-referrer"></script>
		<link rel="stylesheet"
			  href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"
			  integrity="sha512-cUoWMYmv4H9TGP4hbm1mIjYo90WzIQFo/5jj+P5tQcDTf+iVR59RyIj/a9fRsBxzxt5Dnv/Ex7MzRIxcDwaOLw=="
			  crossorigin="anonymous"
			  referrerpolicy="no-referrer" />
	</head>

	<body>
		<div id="map" style="height:100%"></div>
	</body>

	<script>
		var nameRegExp = new RegExp('var name = \'([^\']*)\';')
		var statusRegExp = new RegExp('var status = \'([^\']*)\';')
		var dateRegExp = new RegExp('tilaPaiva: \'([^\']*)\'')
		//var corsProxy = "http://alloworigin.com/get?url=" // no http?
		//var corsProxy = "http://api.allorigins.win/get?url=" // Fucks up encoding?
		//var corsProxy = "http://api.allorigins.win/get?charset=ISO-8859-1&url=" // \o/
		var corsProxy = "https://api.allorigins.win/get?charset=ISO-8859-1&url=" // \o/
		//var corsProxyPost = "http://api.allorigins.win/get?requestMethod=POST&charset=ISO-8859-1&url=" // \o/
		//var corsProxy = "http://cors-proxy.htmldriven.com/?url=" // no http?
		//var corsProxy = "http://www.whateverorigin.org/get?url=" // 404
		var statusUrl = "http://www.mski.fi/mtrack/servlet/mTrackServlet?id=tampere_mskate&cmd=ed&eid=all&temp=luistelukentat_tampere_20"
		statusUrl = encodeURIComponent(statusUrl)
		// POSTing past a cors proxy seems like a hassle. Since the locations rarely change, we can just mirror it statically
		var locationUrl = "wfs"
		//var locationPostBody = "<wfs:GetFeature xmlns:wfs=\"http://www.opengis.net/wfs\" service=\"WFS\" version=\"1.1.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd\"><wfs:Query typeName=\"mski:tampere_luistelukentat\" srsName=\"EPSG:3067\"><ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\"><ogc:BBOX><ogc:PropertyName>the_geom</ogc:PropertyName><gml:Envelope xmlns:gml=\"http://www.opengis.net/gml\" srsName=\"EPSG:3067\"><gml:lowerCorner>319240 6820187</gml:lowerCorner><gml:upperCorner>338760 6824923</gml:upperCorner></gml:Envelope></ogc:BBOX></ogc:Filter></wfs:Query></wfs:GetFeature>"
		//locationPostBody = encodeURIComponent(locationPostBody) // dunno

		var tampereCoords = [61.48, 23.8]
		var map = L.map('map').setView(tampereCoords, 12);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(map);

		/* Btw neovim is being an ass about all these indentations.
				 * This is a quick hack project, I'm not going to bother making
				 * the code the least bit clean
				 */

		// Really could use some more colors, but what can you do.
		// At least I know I'm not going to make new icons
		var icons = {}
		for (color of ['red', 'green', 'orange'])
		{
					icons[color] = new L.AwesomeMarkers.Icon({ markerColor: color });
				}

		var momentFormat = "DD.MM.YYYY HH:mm:ss"

		proj4.defs("EPSG:3067", "+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");

		var getData = async function()
		{
					var statusResp = await fetch(corsProxy + statusUrl)
					var locationResp = await fetch(locationUrl)
					var statusHtml = await statusResp.text()
					var locationXml = await locationResp.text()

					var statuses = scrapeStatusData(statusHtml)
					var locations = scrapeLocationData(locationXml)

					for ({name, status, date} of statuses)
					{
								var statusUpdated = date
								var pos = locations[name]
								if (pos)
								{
											var color = "red"
											var extraClass = null;
											var yesterday = moment().subtract(1, 'days')
											if (status == "Luistelukunnossa")
											{
														if (statusUpdated >= yesterday)
														{
																	color = "green"
																}
														else
														{
																	color = "orange"
																}

													}

											var marker = L.marker(pos, {icon: icons[color], extraClasses: "perse"}).bindPopup(name + "<br>" + status + "<br>" + statusUpdated.format(momentFormat) ).addTo(map);
										}
							}
				}

		var scrapeStatusData = function(htmlSource)
		{
					var statuses = []
					var dom = new DOMParser().parseFromString(htmlSource, "text/html");
					var scripts = dom.getElementsByTagName('script');
					for (script of scripts) {
								var script = script.text;
								var name = script.match(nameRegExp);
								var status = script.match(statusRegExp);
								var date = script.match(dateRegExp);
								if (name && status && date)
								{

											name = name[1]
											status = status[1]
											date = date[1]
											date = moment(date, "DD.MM.YYYY HH:mm:ss")
											statuses.push({
														"name": name,
														"status": status,
														"date": date});

										}
							}

					return statuses
				}

		var scrapeLocationData = function(xmlSource)
		{
					var locations = {}
					var dom = new DOMParser().parseFromString(xmlSource, "application/xml");
					var rinks = dom.getElementsByTagName('mski:tampere_luistelukentat')
					for (rink of rinks)
					{
								var name = rink.getElementsByTagName('mski:NIMI')[0].textContent;
								var pos = rink.getElementsByTagName('gml:pos')[0].textContent;
								pos = pos.split(' ').map( s => parseFloat(s))
								pos = proj4('EPSG:3067', 'WGS84', pos).reverse()
								locations[name] = pos
							}
					return locations
				}

		getData();
	</script>
</html>
